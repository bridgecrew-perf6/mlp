# Deploy

[![pipeline status][pipeline-svg]][pipeline-link]
[![Go version][go-svg]][go-link]

**mlp Command Line Tool.**

`mlp` is a comman line tool responsible for creating, updating and deleting kubernetes resources based on files
generated by Mia-Platform Console.  
The main subcommands that the tool has are:

- `interpolate`: fill placeholders in kubernetes files with the values of ENV variables
- `generate`: create files for kubernetes `ConfigMap` and `Secret` based on files and/or ENV values
- `deploy`: create and/or update resources in a kubernetes namespace with the intepolated/generated files

## Install

TODO

## Docs

If you want to read detailed documentation on all the subcommand availables go to the [doc](./docs)

## Pipeline usage

In order to use `mlp` in a pipeline these are the steps to follow:

- In the configuration files use `{{VAR}}` to reference the environment variable `VAR`
- Prepare a `mlp.yaml` file with all the secrets and configmaps to generate and apply inside the cluster (see file structure in [generate](./docs/generate.md)).
- run `mlp generate` with the flags:
  - `--config-file`: the configuration files containing secrets and configmaps structure.
  - `--env-prefix`: the prefixes to use while perfoming the environment variables lookup inside the configuration files.
  - `--out`: output directory in which generated files will be placed
- run `mlp interpolate` with:
  - `--filename`: the files/folders containing files to interpolate. The command does not look into sub-dirs.
  - `--env-prefix`: the prefixes to use while perfoming the environment variables lookup.
  - `--out`: output directory in which generated files will be placed
- run `mlp deploy` with:
  - `--filename`: the files/folders containing files to deploy into the Kubernetes cluster.
  - `--server`: Kubernetes URL
  - `--certificate-authority`: Kubernetes CA 
  - `--token`: Kubernetes token
  - `--namespace`: the namespace in which the resources will be deployed
  
Example:

The `script` section of the CI file should look like this:

```
  script:
    - mkdir OUTPUT_DIR
    - mlp generate -c config-file.yaml -e FIRST_PREFIX -e SECOND_PREFIX -o OUTPUT_DIR
    - mlp interpolate -f SOURCE_PATH -e FIRST_PREFIX -e SECOND_PREFIX -o OUTPUT_DIR
    - mlp deploy --server KUBERNETES_URL --certificate-authority /path/to/kubernetes/ca.pem --token KUBERNETES_TOKEN -f OUTPUT_DIR -n KUBERNETES_NAMESPACE

```

Note that `mlp` suppose that the output directory already exists so it needs to be created before using the command.

## Contributing

Partecipation to the project is governed by the [Code of Conduct](./CODE_OF_CONDUCT.md) and you can read
how you can improve the project in the [Contributing](./CONTRIBUTING.md) guidelines.

[pipeline-svg]: https://git.tools.mia-platform.eu/platform/devops/deploy/badges/master/pipeline.svg
[pipeline-link]: https://git.tools.mia-platform.eu/platform/devops/deploy/-/commits/master
[go-svg]: https://img.shields.io/badge/Go-1.15-blue
[go-link]: https://golang.org (Go is an open source programming language that makes it easy to build simple, reliable, and efficient software.)
